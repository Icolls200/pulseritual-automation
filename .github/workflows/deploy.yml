name: PulseRituals Daily Video
on:
  schedule:
    - cron: '0 5 * * *'  # 5 AM UTC daily
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Set date variables
        id: date
        run: |
          echo "today=$(date +'%B %d')" >> $GITHUB_OUTPUT
          echo "video_url=https://raw.githubusercontent.com/Icolls200/pulseritual-automation/main/test-video.mp4" >> $GITHUB_OUTPUT
          echo "social_proof=$(shuf -i 1000-2000 -n 1)" >> $GITHUB_OUTPUT
          echo "scarcity=$(shuf -i 50-150 -n 1)" >> $GITHUB_OUTPUT
      
      - name: Post to Facebook
        id: fb_post
        run: |
          response=$(curl -s -X POST "https://graph.facebook.com/v20.0/pulserituals/videos" \
            -F "file_url=${{ steps.date.outputs.video_url }}" \
            -F "description=Your PulseRituals for ${{ steps.date.outputs.today }} â¤ï¸ @pulserituals\n\nStudies suggest ritual consistency supports biological rhythm patterns (studies suggest)" \
            -F "container_type=REEL" \
            -F "access_token=${{ secrets.FB_TOKEN }}")
          echo "post_id=$(echo $response | grep -oP '"id":"\K[^"]+')" >> $GITHUB_OUTPUT
      
      - name: Cross-post to Instagram
        id: ig_post
        run: |
          # Create Instagram media container
          container=$(curl -s "https://graph.facebook.com/v20.0/me/media" \
            -F "video_url=${{ steps.date.outputs.video_url }}" \
            -F "media_type=VIDEO" \
            -F "access_token=${{ secrets.FB_TOKEN }}")
          
          # Publish to Instagram
          curl -X POST "https://graph.facebook.com/v20.0/me/media_publish" \
            -F "creation_id=$(echo $container | grep -oP '"id":"\K[^"]+')" \
            -F "access_token=${{ secrets.FB_TOKEN }}"
      
      - name: Wait for initial engagement
        run: sleep 900  # 15 minutes (algorithm "organic virality" signal)
      
      - name: Post hashtags comment (Facebook)
        run: |
          curl -X POST "https://graph.facebook.com/v20.0/${{ steps.fb_post.outputs.post_id }}/comments" \
            -F "message=#PulseRituals #BioHacking #MorningRitual #EnergyRitual #FocusFlow #RitualScience #CortisolReset #BiologicalRhythm #NeuroscienceRitual #RitualUpgrade" \
            -F "access_token=${{ secrets.FB_TOKEN }}"
      
      - name: Post engagement comment (Facebook)
        run: |
          curl -X POST "https://graph.facebook.com/v20.0/${{ steps.fb_post.outputs.post_id }}/comments" \
            -F "message=FIRST ${{ steps.date.outputs.scarcity }} TAP BIO FOR:\n1) YOUR PERSONAL RITUAL BLUEPRINT\n2) THE 'FOCUS FLOW' RITUAL (USED IN THIS VIDEO)\n3) JOIN ${{ steps.date.outputs.social_proof }} RITUAL UPGRADERS\n\nðŸ‘‰ SCAN QR CODE AT https://pulserituals.bio" \
            -F "access_token=${{ secrets.FB_TOKEN }}"
